---
title: "ndi_analysis"
author: "Harris Policy Lab"
date: "2/16/2021"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# This code uses dplyr functions released in February 2021, so please update dplyr if you have not done so already.

# List of packages to install
packages <- c("tidyverse", "readxl", "janitor", "reticulate", "countrycode", "Hmisc", "lubridate", "skimr", "haven", "scales")

# To install the packages, uncomment the line below and run it
#install.packages(packages)

library(tidyverse)
library(readxl)
library(janitor)
library(reticulate)
library(countrycode)
library(Hmisc)
library(lubridate)
library(skimr)
library(haven)
library(scales)
```

```{r functions, include=FALSE}

fig_max <- function(x) ifelse( !all(is.na(x)), max(x, na.rm = TRUE), NA)
# Source: https://stackoverflow.com/questions/24519794/r-max-function-ignore-na/24520992

```


```{r importing_and_merging, include=FALSE}

## COVID-19 data from Our World in Data ##
  import_owid_covid_data <- read_csv("data/owid-covid-data.csv", 
                                     col_types = cols(
                                       iso_code = col_character(), 
                                       continent = col_character(), 
                                       location = col_character(), 
                                       date = col_date(format = "%m/%d/%Y"),
                                       tests_units = col_character(),
                                     .default = col_double()))
  
  df_covid_owid <- import_owid_covid_data %>%
    clean_names() %>%
    filter(!iso_code %in% c('OWID_AFR', 'OWID_ASI', 'OWID_EUN', 'OWID_EUR',
                                'OWID_INT', 'OWID_KOS', 'OWID_NAM', 'OWID_NCY',
                                'OWID_OCE', 'OWID_SAM', 'OWID_WRL')) %>%
    mutate(
      country_standard = countrycode(
        iso_code, 
        origin = "iso3c", 
        destination = "country.name"),
      name_country_standard = countryname(location),
      year = year(date)) %>%
    select(country_standard, year, date, name_country_standard, everything())
  
  # Summarizing COVID-19 data by year (previous data frame was daily)
  df_covid_owid_yr <- df_covid_owid %>%
    group_by(country_standard, year) %>%
    # Getting cumulative values for the following variables by year and country
    # These values all begin with "cum_eoy" (cumulative by end of year)
    mutate(
      cum_eoy_total_cases = 
        fig_max(total_cases),
      cum_eoy_total_deaths = 
        fig_max(total_deaths),
      cum_eoy_total_cases_per_million = 
        fig_max(total_cases_per_million),
      cum_eoy_total_deaths_per_million = 
        fig_max(total_deaths_per_million),
      cum_eoy_total_tests = 
        fig_max(total_tests),
      cum_eoy_total_tests_per_thousand = 
        fig_max(total_tests_per_thousand),
      cum_eoy_total_vaccinations = 
        fig_max(total_vaccinations),
      cum_eoy_people_vaccinated = 
        fig_max(people_vaccinated),
      cum_eoy_people_fully_vaccinated = 
        fig_max(people_fully_vaccinated),
      cum_eoy_total_vaccinations_per_hundred = 
        fig_max(total_vaccinations_per_hundred),
      cum_eoy_people_vaccinated_per_hundred = 
        fig_max(people_vaccinated_per_hundred),
      cum_eoy_people_fully_vaccinated_per_hundred = 
        fig_max(people_fully_vaccinated_per_hundred)) %>%
    summarise(across(where(is.numeric), mean, na.rm = TRUE), .groups = "keep") %>%
    ungroup() %>%
    group_by(country_standard) %>%
    arrange(year) %>%
    mutate(
      # Finding amounts per year
      # These values all begin with "annual"
      annual_total_cases = ifelse(
        year == 2020,
        cum_eoy_total_cases,
        cum_eoy_total_cases - lag(cum_eoy_total_cases)),
      annual_total_deaths = ifelse(
        year == 2020,
        cum_eoy_total_deaths,
        cum_eoy_total_deaths - lag(cum_eoy_total_deaths)),
      annual_total_cases_per_million = ifelse(
        year == 2020,
        cum_eoy_total_cases_per_million,
        cum_eoy_total_cases_per_million - lag(cum_eoy_total_cases_per_million)),
      annual_total_deaths_per_million = ifelse(
        year == 2020,
        cum_eoy_total_deaths_per_million,
        cum_eoy_total_deaths_per_million - lag(cum_eoy_total_deaths_per_million)),
      annual_total_tests = ifelse(
        year == 2020,
        cum_eoy_total_tests,
        cum_eoy_total_tests - lag(cum_eoy_total_tests)),
      annual_total_tests_per_thousand = ifelse(
        year == 2020,
        cum_eoy_total_tests_per_thousand,
        cum_eoy_total_tests_per_thousand - lag(cum_eoy_total_tests_per_thousand)),
      annual_total_vaccinations = ifelse(
        year == 2020,
        cum_eoy_total_vaccinations,
        cum_eoy_total_vaccinations - lag(cum_eoy_total_vaccinations)),
      annual_people_vaccinated = ifelse(
        year == 2020,
        cum_eoy_people_vaccinated,
        cum_eoy_people_vaccinated - lag(cum_eoy_people_vaccinated)),
      annual_people_fully_vaccinated = ifelse(
        year == 2020,
        cum_eoy_people_fully_vaccinated,
        cum_eoy_people_fully_vaccinated - lag(cum_eoy_people_fully_vaccinated)),
      annual_total_vaccinations_per_hundred = ifelse(
        year == 2020,
        cum_eoy_total_vaccinations_per_hundred,
        cum_eoy_total_vaccinations_per_hundred - lag(cum_eoy_total_vaccinations_per_hundred)),
      annual_people_vaccinated_per_hundred = ifelse(
        year == 2020,
        cum_eoy_people_vaccinated_per_hundred,
        cum_eoy_people_vaccinated_per_hundred - lag(cum_eoy_people_vaccinated_per_hundred)),
      annual_people_fully_vaccinated_per_hundred = ifelse(
        year == 2020,
        cum_eoy_people_fully_vaccinated_per_hundred,
        cum_eoy_people_fully_vaccinated_per_hundred - lag(cum_eoy_people_fully_vaccinated_per_hundred)),
      # Getting cumulative totals across years
      # These values all begin with "cum"
      cum_total_cases = 
        fig_max(cum_eoy_total_cases),
      cum_total_deaths = 
        fig_max(cum_eoy_total_deaths),
      cum_total_cases_per_million = 
        fig_max(cum_eoy_total_cases_per_million),
      cum_total_deaths_per_million = 
        fig_max(cum_eoy_total_deaths_per_million),
      cum_total_tests = 
        fig_max(cum_eoy_total_tests),
      cum_total_tests_per_thousand = 
        fig_max(cum_eoy_total_tests_per_thousand),
      cum_total_vaccinations = 
        fig_max(cum_eoy_total_vaccinations),
      cum_people_vaccinated = 
        fig_max(cum_eoy_people_vaccinated),
      cum_people_fully_vaccinated = 
        fig_max(cum_eoy_people_fully_vaccinated),
      cum_total_vaccinations_per_hundred = 
        fig_max(cum_eoy_total_vaccinations_per_hundred),
      cum_people_vaccinated_per_hundred = 
        fig_max(cum_eoy_people_vaccinated_per_hundred),
      cum_people_fully_vaccinated_per_hundred = 
        fig_max(cum_eoy_people_fully_vaccinated_per_hundred)    
      ) %>%
    ungroup() %>%
    arrange(country_standard, year)
    
########################################      
  
## Economist Intelligence Unit ##

    # The line below runs an R script that cleans the raw EIU data and 
    #   merges it as the EIU_democracy_index_clean.csv file
    source("data/raw_data/clean_eiu_raw.R", echo =  FALSE)

  import_EIU <- read_csv("data/EIU_democracy_index_clean.csv")
  
  df_eiu <- import_EIU %>%
    clean_names() %>%
    mutate(
      # Countries from 2020 are missing iso codes
      geo =
        ifelse(
          is.na(geo),
          countrycode(country, origin = 'country.name', destination = 'iso3c'),
          geo
          ),
      country_standard = countrycode(
        geo, 
        origin = "iso3c", 
        destination = "country.name"
        )) %>%
    # Adding "eiu" prefix to column names
    rename_with( 
    ~ paste("eiu", .x, sep = "_"), 
    overall_score:date) %>%
    select(country_standard, year, eiu_overall_score:eiu_regime_type, -eiu_rank, -eiu_rank_change)

########################################    
  
## Transparency International Corruption Perception Index
  
  import_CPI_Transparency_International <- read_excel("data/CPI_Transparency_International.xlsx")
  
  df_cpi <- import_CPI_Transparency_International %>%
    clean_names() %>%
    mutate(
      country_standard = countrycode(
        country_code,
        origin = "iso3c",
        destination = "country.name")) %>%
    select(country_standard, year, cpi_score)
  
########################################     
      
## Data from Open Government Partnership ##
  
  import_OGP_data <- read_excel("data/OGP_data.xlsx", 
                                col_types = c(
                                  "text", "numeric", "numeric", "numeric"))
  
  df_ogp <- import_OGP_data %>%
    clean_names() %>%
    rename(ogp_2019_considerations_transparency = ogp_considerations_transparency) %>%
    mutate(
      country_standard = countrycode(
        country_code,
        origin = "iso3c",
        destination = "country.name"),
      ogp_2019_considerations_text = case_when(
        ogp_2019_considerations_transparency == 1 ~ "Consider Action",
        ogp_2019_considerations_transparency == 2 ~ "Implement for Results",
        ogp_2019_considerations_transparency == 3 ~ "Share Innovation",
        TRUE ~ NA_character_
        )
      ) %>%
    select(country_standard, everything(), -country_code)  
  
  # Merging with large list of countries in previously saved merged_data_yr 
  # and assigning "zero" values to the ogp_participating variable for countries
  # not included in the imported OGP dataset
  df_ogp <- read_csv("data/merged_data_yr.csv") %>%
    select(country_standard, year) %>%
    distinct() %>%
    full_join(df_ogp, by = c("country_standard", "year")) %>%
    mutate(ogp_participating = ifelse(
      is.na(ogp_participating),
      0,
      ogp_participating
    ))

########################################    
  
## WGI indicators ##
  
  # Voice & Accountability and Control of Corruption
  
  import_Worldwide_Governance_Indicators_clean <- read_csv("data/Worldwide_Governance_Indicators_clean.csv")
  
  df_wgi <- import_Worldwide_Governance_Indicators_clean %>%
    clean_names() %>%
    rename(country = country_territory) %>%
    # The countrycodes package does not include Kosovo or the Netherlands Antilles
    filter(!country %in% c("Kosovo", "Netherlands Antilles (former)")) %>%
    mutate(
      country = case_when(
        code == "CIV" ~ "Ivory Coast",
        code == "STP" ~ "Sao Tome and Principe",
        code == "REU" ~ "Reunion",
        TRUE ~ country),
      iso_code = countrycode(country, origin = 'country.name', destination = 'iso3c'),        
      country_standard = countrycode(
          iso_code, 
          origin = "iso3c", 
          destination = "country.name"
          )) %>%
    # Adding "wgi" prefix to indicators
    rename_with( 
      ~ paste("wgi", .x, sep = "_"),
      voice_and_accountability:control_of_corruption) %>%
    select(country_standard, year, everything(), -x1, -country, -iso_code)

  # Government Effectiveness
  import_wgi_gov_effective <- read_excel("data/wgi_gov_effective.xlsx", na = "NA")
  
  df_wgi_effect <- import_wgi_gov_effective %>%
    clean_names() %>%
    mutate(
      country_standard = countrycode(
        code,
        origin = "iso3c",
        destination = "country.name")) %>%
    filter(!is.na(country_standard)) %>%
    select(country_standard, everything(), -country_territory, -code) %>%
    pivot_longer(!country_standard, names_to = "year", values_to = "wgi_govt_effective") %>%
    mutate(
      year = as.numeric(
        str_remove(year, "x"))) %>%
    arrange(country_standard, year)
    
    
########################################    
  
## V-Dem indicators ##
  
  import_vdem_clean <- read_csv("data/vdem_clean.csv")
  
  df_vdem <- import_vdem_clean %>%
    clean_names() %>%
    # This data set has a very large range of years. Limiting to 2006 and later
    filter(year >= 2006) %>%
    filter(!country_name %in% c("Kosovo", "Somaliland", "Zanzibar")) %>%  
    mutate(
      iso_code = countrycode(country_name, origin = 'country.name', destination = 'iso3c'),        
      country_standard = countrycode(
          iso_code, 
          origin = "iso3c", 
          destination = "country.name"
          )) %>%
    # Adding "vdem" prefix to indicators      
    rename_with( 
      ~ paste("vdem", .x, sep = "_"),
      v2x_libdem:v2x_cspart) %>%
    select(country_standard, year, everything(), -country_name, -iso_code)    
  
  # Data from V-Dem's "Pandemic Backsliding" Project
  import_pandem <- read_csv("data/PanDem_cs_V5.csv")
  
  df_pandem <- import_pandem  %>%
    clean_names() %>%
    mutate(
      iso_code = countrycode(country_name, origin = 'country.name', destination = 'iso3c'),        
      country_standard = countrycode(
          iso_code, 
          origin = "iso3c", 
          destination = "country.name"
          )) %>%
    select(country_standard, pandem, panback) %>%
    distinct()
  
########################################    
  
## Freedom House indicators ##
  import_Freedom_house <- read_excel("data/Freedom_house.xlsx")
  
  df_fh <- import_Freedom_house %>%
    clean_names() %>%
    select(-country_territory) %>%
    filter(!countries %in% 
             c('Abkhazia', 'Crimea', 'Eastern Donbas', 'Kosovo', 'Micronesia',
               'Nagorno-Karabakh', 'Somaliland', 'South Ossetia', 'Tibet',
               'Transnistria')) %>%
    # If I want to take out the line below, import sheet two from the excel file instead
    pivot_longer(!countries, names_to = "year", values_to = "fh_global_freedom_score") %>%
    mutate(
      iso_code = countrycode(countries, origin = 'country.name', destination = 'iso3c'),        
      country_standard = countrycode(
          iso_code, 
          origin = "iso3c", 
          destination = "country.name"),
      year = as.numeric(str_remove(year, "x"))) %>%
    select(country_standard, year, fh_global_freedom_score) %>%
    arrange(country_standard, year)

########################################      
    
## Africa Integrity Indicators ##
  
  import_africa_integrity <- read_excel("data/Africa_Integrity_Indictors_CLEAN_22021.xlsx", na = "n/a")
  
  df_africa_int <- import_africa_integrity %>%
    clean_names()  %>% 
    select(
      country,
      year,
      in_practice_citizens_can_access_the_results_and_documents_associated_with_procurement_contracts_full_contract_proposals_execution_reports_financial_audits_etc,
      in_law_citizens_have_a_right_to_request_public_information_from_state_bodies,
      in_practice_citizen_requests_for_public_information_are_effective,
      in_practice_citizens_can_access_legislative_processes_and_documents,
      in_law_senior_officials_of_the_three_branches_of_government_including_heads_of_state_and_government_ministers_members_of_parliament_judges_etc_are_required_to_disclose_records_of_their_assets_and_disclosures_are_public,
      in_law_political_parties_are_required_to_regularly_disclose_private_donations,
      in_law_corruption_is_criminalized_as_a_specific_offense,
      in_practice_the_body_bodies_that_investigate_s_allegations_of_public_sector_corruption_is_are_effective,
      in_law_civil_servants_who_report_cases_of_corruption_are_protected_from_recrimination_or_other_negative_consequences,
      in_law_there_is_an_independent_body_bodies_mandated_to_receive_and_investigate_cases_of_alleged_public_sector_corruption
    )
  
  names(df_africa_int) <- names(df_africa_int) %>% 
    str_remove("^in_practice_") %>% 
    str_remove("^in_law_") %>% 
    str_trunc(32,  ellipsis = "")
    
  #names(df_africa_int) <- abbreviate(names(df_africa_int), minlength = 16)
  #names(df_africa_int) <- names(df_africa_int) %>% str_replace_all("\\_{2,}", "")
  names(df_africa_int) <- names(df_africa_int) %>% make.unique()
  
  df_africa_int <- df_africa_int %>%
    mutate(
      country = ifelse(
        country == "sundan",
        "sudan",
        country),
      iso_code = countrycode(country, origin = 'country.name', destination = 'iso3c'),
      country_standard = countrycode(
        iso_code, 
        origin = "iso3c", 
        destination = "country.name"
        )) %>%
    select(country_standard, year, everything(), -country) %>%    
    # Adding "afr_int" prefix to column names
    rename_with( 
    ~ paste("afr_int", .x, sep = "_"), 
    !(country_standard:year)) %>%
    filter(!is.na(year))
  
########################################    
  
## Public health expenditures as share of GDP   
  import_gdp_pub_health_expenditures <- read_csv("data/public-health-expenditure-share-GDP-OWID.csv")
  
  df_gdp_health_expend <- import_gdp_pub_health_expenditures %>%
    clean_names() %>%
    # This data set has a very large range of years. Limiting to 2006 and later    
    filter(year >= 2006) %>%
    rename(pub_health_exp_percent_gdp = public_expenditure_on_health_percent_gdp_owid_extrapolated_series) %>%
    mutate(country_standard = countrycode(
      code, 
      origin = "iso3c", 
      destination = "country.name")) %>%
    select(country_standard, year, pub_health_exp_percent_gdp, everything())

  attr(df_gdp_health_expend$pub_health_exp_percent_gdp, "label") <- "Public expenditure on health as a percent of GDP"
    
########################################    
  
##  Public health expenditures per capita ##
  
  import_percap_Public_Health_Expenditure <- read_csv("data/WB_Public_Health_Expenditure_v3.csv")
  
  df_percap_health_expend <- import_percap_Public_Health_Expenditure %>%
    clean_names() %>%
    # The data includes entries for "Arab World" as a country. Removing that.
    filter(country_code != "ARB") %>%
    mutate(country_standard = countrycode(
      country_code, 
      origin = "iso3c", 
      destination = "country.name")) %>%
    rename(percap_domestic_health_expenditure = domestic_health_expenditure) %>%
    select(country_standard, year, everything(), -country_name, -country_code)

########################################      
    
## GDP Data ##
  
  # We're using GDP as a control variable
  import_GDP_data <- read_excel("data/GDP_data.xlsx")
  
  df_gdp <- import_GDP_data %>%
    clean_names() %>%
    filter(!country_code %in% 
    c('ARB', 'CEB', 'CSS', 'EAP', 'EAR', 'EAS', 'ECA', 'ECS', 'EMU', 'EUU', 
    'FCS', 'HIC', 'HPC', 'IBD', 'IBT', 'IDA', 'IDB', 'IDX', 'INX', 'LAC', 
    'LCN', 'LDC', 'LIC', 'LMC', 'LMY', 'LTE', 'MEA', 'MIC', 'MNA', 'NAC', 
    'OED', 'OSS', 'PRE', 'PSS', 'PST', 'SAS', 'SSA', 'SSF', 'SST', 'TEA', 
    'TEC', 'TLA', 'TMN', 'TSA', 'TSS', 'UMC', 'WLD')) %>%
    mutate(country_standard = countrycode(
      country_code, 
      # Note that this uses WB as country code style, not iso3c
      origin = "wb", 
      destination = "country.name")) %>%
    filter(!is.na(country_standard)) %>%
    select(country_standard, year, gdp)
    
########################################    
  
## Gini Coefficient ##
  
  # We're using the Gini coefficient as a control variable
  import_Gini_coefficient_2020 <- read_csv("data/Gini_coefficient_2020.csv")
  
  df_gini <- import_Gini_coefficient_2020 %>%
    clean_names() %>%
      mutate(
        iso_code = countrycode(country, origin = 'country.name', destination = 'iso3c'),
        country_standard = countrycode(
          iso_code, 
          origin = "iso3c", 
          destination = "country.name"
          )) %>%
    rename(gini_2020 = gini_coefficient_2020_data) %>%
    select(country_standard, gini_2020)  
```


Merging datasets

```{r merging_data, include=FALSE}
  df_all <- df_covid_owid %>%
    full_join(df_eiu, by = c("country_standard", "year")) %>%
    full_join(df_cpi, by = c("country_standard", "year")) %>%
    full_join(df_ogp, by = c("country_standard", "year")) %>%  
    full_join(df_wgi, by = c("country_standard", "year")) %>% 
    full_join(df_wgi_effect, by = c("country_standard", "year")) %>%
    full_join(df_vdem, by = c("country_standard", "year")) %>% 
    full_join(df_pandem, by = "country_standard") %>%      
    full_join(df_fh, by = c("country_standard", "year")) %>%       
    full_join(df_gdp_health_expend, by = c("country_standard", "year")) %>%
    full_join(df_percap_health_expend, by = c("country_standard", "year")) %>%
    full_join(df_gdp, by = c("country_standard", "year")) %>%
    full_join(df_gini, by = "country_standard") %>%
    full_join(df_africa_int, by = c("country_standard", "year")) %>%
    select(
      country_standard, 
      year, 
      date,
      median_age:aged_65_older,
      gdp_per_capita,
      eiu_overall_score:eiu_regime_type,
      ogp_2019_considerations_transparency:ogp_2019_considerations_text,
      pub_health_exp_percent_gdp,
      everything(),
      -name_country_standard,
      -location,
      -code.x,
      -entity
      ) %>%
    mutate(post_covid = 
             ifelse(year >= 2020,
                    TRUE,
                    FALSE))

  # Looking at entries where ISO codes didn't match with a country
  df_no_country <- df_all %>% filter((is.na(country_standard)))
  
  # Removing entries with missing country_standard name
  df_all <- df_all %>% filter(!(is.na(country_standard)))
  
  # Limiting to the year 2006 and later
  df_all <- df_all %>% filter(year >= 2006)

  # Exporting df_all
  write_csv(df_all, "data/merged_data.csv")
  
  ## By year instead of date ##
  df_all_yr <- df_covid_owid_yr %>%
    full_join(df_eiu, by = c("country_standard", "year")) %>%
    full_join(df_cpi, by = c("country_standard", "year")) %>%
    full_join(df_ogp, by = c("country_standard", "year")) %>%  
    full_join(df_wgi, by = c("country_standard", "year"))  %>% 
    full_join(df_wgi_effect, by = c("country_standard", "year")) %>%
    full_join(df_vdem, by = c("country_standard", "year")) %>% 
    full_join(df_pandem, by = "country_standard") %>%      
    full_join(df_fh, by = c("country_standard", "year")) %>%       
    full_join(df_gdp_health_expend, by = c("country_standard", "year")) %>%
    full_join(df_percap_health_expend, by = c("country_standard", "year")) %>%
    full_join(df_gdp, by = c("country_standard", "year")) %>%
    full_join(df_gini, by = "country_standard") %>%
    full_join(df_africa_int, by = c("country_standard", "year")) %>%
    select(
      country_standard, 
      year, 
      median_age:aged_65_older,
      gdp_per_capita,
      eiu_overall_score:eiu_regime_type,
      ogp_2019_considerations_transparency:ogp_2019_considerations_text,
      pub_health_exp_percent_gdp,
      everything(),
      -code.x,
      -entity
      ) %>%
    mutate(post_covid = 
             ifelse(year >= 2020,
                    TRUE,
                    FALSE))
  
    # Limiting to the year 2006 and later
          # Some data (including WGI and Gini index) go back further
    df_all_yr <- df_all_yr %>% filter(year >= 2006)
    
    # Looking specifically at 2020
    df_all_yr_2020 <- df_all_yr %>% filter(year == 2020)
  
    # Exporting df_all_yr
    write_csv(df_all_yr, "data/merged_data_yr.csv")
    write_csv(df_all_yr_2020, "data/merged_data_yr_2020.csv")
  
```

When reviewing the data, a helpful link for issues: https://github.com/ropensci/skimr/issues/606

```{r covid_controls, echo=TRUE}

# Controls for COVID outcomes
df_covid_controls <- df_all_yr %>%
  arrange(country_standard, year) %>%
  group_by(country_standard) %>%
  # These variables don't have values in 2020. Filling in from most recent year
  fill(
    c(gdp, pub_health_exp_percent_gdp, percap_domestic_health_expenditure)) %>%
  filter(year==2020) %>%
  select(
    country_standard, 
    gdp, 
    pub_health_exp_percent_gdp, 
    percap_domestic_health_expenditure)
  
df_covid_controls <- df_all_yr_2020 %>%
  select(
    country_standard, gdp_per_capita, gini_2020, median_age, aged_65_older) %>%
  full_join(df_covid_controls, by = "country_standard") %>% 
  select(
    country_standard, gdp, gdp_per_capita, gini_2020, 
        # we discussed using "public health expenditure as a proportion of GDP"
        # as an indicator, but it seemed very similar to the next indicator
        # below, which is "public health expenditure per capita"
    #pub_health_exp_percent_gdp, 
    percap_domestic_health_expenditure, 
    median_age, aged_65_older)

write_csv(df_covid_controls, "data/covid-19_controls.csv")

```


# Creating an index for COVID-19 health factors

Our COVID-19 index comes from country-level measures starting from January 1, 2020. The measures are used in the following equation: (1 / COVID-19 cases per million) * (1 / COVID-19 deaths per million) * (total COVID-19 tests per thousand)

The intuition is that countries will have a higher index score if they have fewer cases, fewer deaths, and more tests. The index is scaled from 0 (worst) to 1 (best).

We decided on this index after testing it among six considered models. We regressed each index on our list of control variables and compared the F-statistic of each model. The chosen model had the second highest F-Statistic, but was chosen because a review of the country rankings of the model with the highest F-statistic revealed it to be a poor index.

To see the code for the process above, see reference_dode/covid_index_select.r

For countries that were missing data on COVID-19 tests, they are assigned a score of "1" on the scale of 1 to 10 used for countries' testing rates.

```{r covid_index, echo=TRUE}
df_covid_index <- df_all_yr %>%
  select(
    country_standard, 
    cum_total_cases_per_million, 
    cum_total_deaths_per_million,
    cum_total_tests_per_thousand) %>%
  filter(
    if_any(
      cum_total_cases_per_million:cum_total_deaths_per_million, 
      ~ !is.na(.))) %>%  
  distinct() %>%
  mutate(
        # Use a scale of 1 - 10 to avoid having "0" in denominator
    stand_total_cases_per_million  = rescale(cum_total_cases_per_million, to = c(1, 10)),
    stand_total_deaths_per_million = rescale(cum_total_deaths_per_million, to = c(1, 10)),
    stand_total_tests_per_thousand = rescale(cum_total_tests_per_thousand, to = c(1, 10)),
    stand_total_tests_per_thousand_no_NA = ifelse(
      is.na(stand_total_tests_per_thousand), 
      1, 
      stand_total_tests_per_thousand),
    covid_index = rescale(
      (1/stand_total_cases_per_million) +
      (1/stand_total_deaths_per_million) +
      stand_total_tests_per_thousand_no_NA)
    ) %>%
  select(country_standard, covid_index, everything())

# Reviewing distribution of the data
histogram(df_covid_index$stand_total_cases_per_million)
histogram(df_covid_index$stand_total_deaths_per_million)
histogram(df_covid_index$stand_total_tests_per_thousand_no_NA)
histogram(df_covid_index$covid_index)

# RUnning a regression of control variables on COVID-19 index
covid_index_mod_test <- df_covid_index %>% 
  select(country_standard, covid_index) %>%
  full_join(df_covid_controls, by = "country_standard") %>%
  select(-country_standard)

  lm(covid_index ~ ., data = covid_index_mod_test) %>% summary()

write_csv(df_covid_index, "data/covid-19_index.csv")

```




You can do python code, like in example chunk below.

```{python include=FALSE}
print("hello world")
```

## Notes to self:

We don't have 2020 GDP data

There are about 20 countries missing Gini index data

From OWID Covid, look at "stringeny_index"


Additional ideas for controls:

-   df_covid_owid

    -   "population_density"

    -   "gdp_per_capita"

    -   "extreme_poverty"

    -   "cardiovasc_death_rate"

    -   "diabetes_prevalence"

    -   "female_smokers"

    -   "male_smokers"

    -   "handwashing_facilities"

    -   "hospital_beds_per_thousand"

    -   "life_expectancy"

    -   "human_development_index"

## Resources:

-   

## Citations:

This project uses the countrycode R package

Arel-Bundock, Vincent, Nils Enevoldsen, and CJ Yetman, (2018). countrycode: An R package to convert country names and country codes. Journal of Open Source Software, 3(28), 848, <https://doi.org/10.21105/joss.00848>
