---
title: "ndi_analysis"
author: "Harris Policy Lab"
date: "2/16/2021"
output: html_document
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# List of packages to install
packages <- c("tidyverse", "readxl", "janitor", "reticulate", "countrycode", "Hmisc", "lubridate")

# To install the packages, uncomment the line below and run it
#install.packages(packages)

library(tidyverse)
library(readxl)
library(janitor)
library(reticulate)
library(countrycode)
library(Hmisc)
library(lubridate)

```

```{r importing_and_merging}

## COVID-19 data from Our World in Data ##
  import_owid_covid_data <- read_csv("data/owid-covid-data.csv")
  df_covid_owid <- import_owid_covid_data %>%
    clean_names() %>%
    mutate(
      country_standard = countrycode(
        iso_code, 
        origin = "iso3c", 
        destination = "country.name"),
      name_country_standard = countryname(location),
      date = mdy(date),
      year = year(date)) %>%
    select(country_standard, year, name_country_standard, everything())
  
## Economist Intelligence Unit ##

    # The line below runs an R script that cleans the raw EIU data and 
    #   merges it as the EIU_democracy_index_clean.csv file
    source("data/raw_data/clean_eiu_raw.R", echo =  FALSE)

  import_EIU <- read_csv("data/EIU_democracy_index_clean.csv")
  df_eiu <- import_EIU %>%
    clean_names() %>%
    mutate(
      # Countries from 2020 are missing iso codes
      geo =
        ifelse(
          is.na(geo),
          countrycode(country, origin = 'country.name', destination = 'iso3c'),
          geo
          ),
      country_standard = countrycode(
        geo, 
        origin = "iso3c", 
        destination = "country.name"
        )) %>%
    # Adding "OGP" prefix to column names
    rename_with( 
    ~ paste("eiu", .x, sep = "_"), 
    overall_score:date) %>%
    select(country_standard, year, eiu_overall_score:eiu_regime_type)
  
## Data from Open Government Partnership ##
  import_OGP_data <- read_excel("data/OGP_data.xlsx")
  df_ogp <- import_OGP_data %>%
    clean_names() %>%
    mutate(
      country_standard = countrycode(
        country_code,
        origin = "iso3c",
        destination = "country.name")) %>%
    # Adding "OGP" prefix to column names
    rename_with( 
    ~ paste("ogp", .x, sep = "_"), 
    c(date_joined, current_action_plan, open_budget_survey_transparency_score)) %>%
    select(country_standard, everything())

## WHO public health expenditures    
  import_pub_health_expenditures <- read_csv("data/public-health-expenditure-share-GDP-OWID.csv")
  df_who_health_expend <- import_pub_health_expenditures %>%
    clean_names() %>%
    rename(who_pub_health_exp_percent_gdp = public_expenditure_on_health_percent_gdp_owid_extrapolated_series) %>%
    mutate(country_standard = countrycode(
      code, 
      origin = "iso3c", 
      destination = "country.name")) %>%
    select(country_standard,year, who_pub_health_exp_percent_gdp, everything())
  
  label(df_who_health_expend$who_pub_health_exp_percent_gdp) <- "Public expenditure on health as a percent of GDP"

### Merging datasets ###
  df_all <- df_covid_owid %>%
    full_join(df_eiu, by = c("country_standard", "year")) %>%
    full_join(df_ogp, by = "country_standard") %>%  
    full_join(df_who_health_expend, by = c("country_standard", "year")) %>%  
    select(
      country_standard, 
      year, 
      date,
      median_age:aged_65_older,
      gdp_per_capita,
      eiu_overall_score:eiu_regime_type,
      ogp_participating:ogp_average_score,
      who_pub_health_exp_percent_gdp,
      everything()) %>%
    filter(!(is.na(country_standard))) %>%
    mutate(post_covid = 
             ifelse(year >= 2020,
                    TRUE,
                    FALSE))

# Exporting dataset
  write_csv(df_all, "data/merged_data.csv")
```

Note that for OGP data, the following country codes don't appear to be iso3c and don't match to a country name: ARBA, BRSP, CAON, CONR, ESMD, ESPV, FRPA, GBSC, GETB, GHST, IDBO, KEEM, KRSE, MXJL, NGKD, PELL, PHSC, ROIS, TZKG, USAU

You can do python code, like in example chunk below.

```{python}
print("hello world")
```

## Notes:

Additional ideas for controls:

-   df_covid_owid

    -   "population_density"

    -   "gdp_per_capita"

    -   "extreme_poverty"

    -   "cardiovasc_death_rate"

    -   "diabetes_prevalence"

    -   "female_smokers"

    -   "male_smokers"

    -   "handwashing_facilities"

    -   "hospital_beds_per_thousand"

    -   "life_expectancy"

    -   "human_development_index"

## Resources:

-   

## Citations:

This project uses the countrycode R package

Arel-Bundock, Vincent, Nils Enevoldsen, and CJ Yetman, (2018). countrycode: An R package to convert country names and country codes. Journal of Open Source Software, 3(28), 848, <https://doi.org/10.21105/joss.00848>
